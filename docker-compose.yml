services:
  chatmock:
    build: .
    image: chatmock:latest
    container_name: chatmock
    command: ["serve"]
    env_file: .env
    environment:
      - CHATGPT_LOCAL_HOME=/data
      - PORT=${PORT:-8000}
    ports:
      - "127.0.0.1:${PORT:-8000}:${PORT:-8000}"
    volumes:
      - ./data/chatmock_data:/data
      - ./prompt.md:/app/prompt.md:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python - <<'PY'\nimport urllib.request, sys, os\nport = os.environ.get('PORT', '8000')\ntry:\n  r = urllib.request.urlopen(f'http://127.0.0.1:{port}/health', timeout=2)\n  sys.exit(0 if r.status == 200 else 1)\nexcept:\n  sys.exit(1)\nPY"
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

